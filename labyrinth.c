#include <ncurses.h>
#include <stdbool.h>
#include <string.h>
#include "labyrinth.h"

void input_handler(Game *g){
    char ch = getch();

    if(ch == 'q'){
        g->running = false;
    }
    else if(ch == 'r'){
        g->player.y = 1;
        g->player.x = 1;
    }
    else if(ch == 'w'){
        if(g->map.tiles[g->player.y -1 ][g->player.x] == 0){
            g->player.y --;
        }
    }
    else if(ch == 'a'){
        if(g->map.tiles[g->player.y][g->player.x - 1] == 0){
            g->player.x --;
        }
    }
    else if(ch == 's'){
        if(g->map.tiles[g->player.y + 1][g->player.x] == 0){
            g->player.y ++;
        }
    }
    else if(ch == 'd'){
        if(g->map.tiles[g->player.y][g->player.x + 1] == 0){
            g->player.x ++;
        }
    }
}

void main_loop (Game *g){
    while(g->running == true){
        for(int i = 0; i <= ROWS - 1; i++){
            for(int j = 0; j <= COLS - 1; j++){
                if (i == g->player.y && j == g->player.x){
                    printw("<>");
                }
                else if(g->map.tiles[i][j] == 0){
                    printw("  ");
                }
                else if(g->map.tiles[i][j] == 1){
                    printw("[]");
                }
            }
            printw("\n");
        }

        refresh();
        input_handler(g);
        erase();
    }
}

void init_map(Map *m) {
    int layout[ROWS][COLS] = {
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,1,1},
        {1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,0,1,0,1,1},
        {1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,1,0,1,1},
        {1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,0,1,1},
        {1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,1,1},
        {1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,1},
        {1,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,1,1},
        {1,1,1,0,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1,1},
        {1,0,1,0,1,0,1,0,1,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,0,0,0,1,1},
        {1,0,1,0,1,0,1,0,1,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,1,1,1,1,0,1,1},
        {1,0,1,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,1,0,1,0,1,0,1,0,1,0,1,0,0,0,1,0,1,1},
        {1,0,1,0,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1},
        {1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1},
        {1,0,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1,0,1,0,1,1},
        {1,0,1,0,1,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1},
        {1,0,1,0,1,0,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1,0,1,0,1,1},
        {1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
        {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
    };
    memcpy(m->tiles, layout, sizeof(layout));
}
void init_game(Game *g) {
    g->running = true;
    init_map(&g->map);
    g->player.x = 1;
    g->player.y = 1;
}

int main(void){
    Game g;

    initscr();
    raw();
    curs_set(0);
    noecho();

    init_game(&g);

    main_loop(&g);

    endwin();
    return 0;
}
